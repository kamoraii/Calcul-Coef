<script>
    // Charger les valeurs depuis localStorage
    function chargerValeurs() {
        document.getElementById('prixAchat').value = localStorage.getItem('prixAchat') || '';
        document.getElementById('taux').value = localStorage.getItem('taux') || '';
        document.getElementById('coefficient').value = localStorage.getItem('coefficient') || '';
        document.getElementById('prixVente').value = localStorage.getItem('prixVente') || '';
        document.getElementById('benefice').value = localStorage.getItem('benefice') || '';
        calculer(); // Recalculer au chargement
    }

    // Sauvegarder les valeurs dans localStorage
    function sauvegarderValeurs() {
        localStorage.setItem('prixAchat', document.getElementById('prixAchat').value);
        localStorage.setItem('taux', document.getElementById('taux').value);
        localStorage.setItem('coefficient', document.getElementById('coefficient').value);
        localStorage.setItem('prixVente', document.getElementById('prixVente').value);
        localStorage.setItem('benefice', document.getElementById('benefice').value);
    }

    // Variable pour Ã©viter le recalcul pendant la navigation clavier
    let isEditing = false;

    // Calculer et afficher le rÃ©sultat
    function calculer() {
        if (isEditing) return;

        const prixAchatInput = document.getElementById('prixAchat');
        const tauxInput = document.getElementById('taux');
        const coefficientInput = document.getElementById('coefficient');
        const prixVenteInput = document.getElementById('prixVente');
        const beneficeInput = document.getElementById('benefice');

        const prixAchat = prixAchatInput.value ? parseFloat(prixAchatInput.value) : null;
        const taux = tauxInput.value ? parseFloat(tauxInput.value) : null;
        const coefficient = coefficientInput.value ? parseFloat(coefficientInput.value) : null;
        const prixVente = prixVenteInput.value ? parseFloat(prixVenteInput.value) : null;
        const benefice = beneficeInput.value ? parseFloat(beneficeInput.value) : null;

        // Cas 1 : Prix d'achat + taux â†’ prix de vente, bÃ©nÃ©fice, coefficient
        if (prixAchat !== null && taux !== null) {
            const nouveauPrixVente = prixAchat * (1 + taux / 100);
            const nouveauBenefice = nouveauPrixVente - prixAchat;
            const nouveauCoefficient = nouveauPrixVente / prixAchat;
            prixVenteInput.value = nouveauPrixVente.toFixed(2);
            beneficeInput.value = nouveauBenefice.toFixed(2);
            coefficientInput.value = nouveauCoefficient.toFixed(2);
        }
        // Cas 2 : Prix d'achat + coefficient â†’ prix de vente, bÃ©nÃ©fice, taux
        else if (prixAchat !== null && coefficient !== null) {
            const nouveauPrixVente = prixAchat * coefficient;
            const nouveauBenefice = nouveauPrixVente - prixAchat;
            const nouveauTaux = ((nouveauPrixVente - prixAchat) / prixAchat) * 100;
            prixVenteInput.value = nouveauPrixVente.toFixed(2);
            beneficeInput.value = nouveauBenefice.toFixed(2);
            tauxInput.value = nouveauTaux.toFixed(2);
        }
        // Cas 3 : Prix d'achat + prix de vente â†’ coefficient, taux, bÃ©nÃ©fice
        else if (prixAchat !== null && prixVente !== null) {
            const nouveauBenefice = prixVente - prixAchat;
            const nouveauTaux = ((prixVente - prixAchat) / prixAchat) * 100;
            const nouveauCoefficient = prixVente / prixAchat;
            beneficeInput.value = nouveauBenefice.toFixed(2);
            tauxInput.value = nouveauTaux.toFixed(2);
            coefficientInput.value = nouveauCoefficient.toFixed(2);
        }
        // Cas 4 : Prix d'achat + bÃ©nÃ©fice â†’ prix de vente, coefficient, taux
        else if (prixAchat !== null && benefice !== null) {
            const nouveauPrixVente = prixAchat + benefice;
            const nouveauTaux = (benefice / prixAchat) * 100;
            const nouveauCoefficient = nouveauPrixVente / prixAchat;
            prixVenteInput.value = nouveauPrixVente.toFixed(2);
            tauxInput.value = nouveauTaux.toFixed(2);
            coefficientInput.value = nouveauCoefficient.toFixed(2);
        }
        // Cas 5 : Prix de vente + taux â†’ prix d'achat, bÃ©nÃ©fice, coefficient
        else if (prixVente !== null && taux !== null) {
            const nouveauPrixAchat = prixVente / (1 + taux / 100);
            const nouveauBenefice = prixVente - nouveauPrixAchat;
            const nouveauCoefficient = prixVente / nouveauPrixAchat;
            prixAchatInput.value = nouveauPrixAchat.toFixed(2);
            beneficeInput.value = nouveauBenefice.toFixed(2);
            coefficientInput.value = nouveauCoefficient.toFixed(2);
        }
        // Cas 6 : Prix de vente + coefficient â†’ prix d'achat, bÃ©nÃ©fice, taux
        else if (prixVente !== null && coefficient !== null) {
            const nouveauPrixAchat = prixVente / coefficient;
            const nouveauBenefice = prixVente - nouveauPrixAchat;
            const nouveauTaux = ((prixVente - nouveauPrixAchat) / nouveauPrixAchat) * 100;
            prixAchatInput.value = nouveauPrixAchat.toFixed(2);
            beneficeInput.value = nouveauBenefice.toFixed(2);
            tauxInput.value = nouveauTaux.toFixed(2);
        }
        // Cas 7 : Prix de vente + bÃ©nÃ©fice â†’ prix d'achat, coefficient, taux
        else if (prixVente !== null && benefice !== null) {
            const nouveauPrixAchat = prixVente - benefice;
            const nouveauTaux = (benefice / nouveauPrixAchat) * 100;
            const nouveauCoefficient = prixVente / nouveauPrixAchat;
            prixAchatInput.value = nouveauPrixAchat.toFixed(2);
            tauxInput.value = nouveauTaux.toFixed(2);
            coefficientInput.value = nouveauCoefficient.toFixed(2);
        }
        // Cas 8 : BÃ©nÃ©fice + taux â†’ prix d'achat, prix de vente, coefficient
        else if (benefice !== null && taux !== null) {
            const nouveauPrixAchat = benefice / (taux / 100);
            const nouveauPrixVente = nouveauPrixAchat + benefice;
            const nouveauCoefficient = nouveauPrixVente / nouveauPrixAchat;
            prixAchatInput.value = nouveauPrixAchat.toFixed(2);
            prixVenteInput.value = nouveauPrixVente.toFixed(2);
            coefficientInput.value = nouveauCoefficient.toFixed(2);
        }
        // Cas 9 : BÃ©nÃ©fice + coefficient â†’ prix d'achat, prix de vente, taux
        else if (benefice !== null && coefficient !== null) {
            const nouveauPrixAchat = benefice / (coefficient - 1);
            const nouveauPrixVente = nouveauPrixAchat * coefficient;
            const nouveauTaux = (benefice / nouveauPrixAchat) * 100;
            prixAchatInput.value = nouveauPrixAchat.toFixed(2);
            prixVenteInput.value = nouveauPrixVente.toFixed(2);
            tauxInput.value = nouveauTaux.toFixed(2);
        }

        // Afficher le rÃ©sultat
        const resultatElement = document.getElementById('resultat');
        const beneficeFinal = parseFloat(beneficeInput.value) || 0;
        if (beneficeFinal >= 0) {
            resultatElement.innerHTML = `BÃ©nÃ©fice net : ${beneficeFinal.toFixed(2)} â‚¬ <span class="emoji">ğŸ¤‘ğŸ¤©ğŸ¤Œ</span>`;
            resultatElement.className = 'result profit';
        } else {
            resultatElement.innerHTML = `DÃ©ficit net : ${Math.abs(beneficeFinal).toFixed(2)} â‚¬ <span class="emoji">ğŸ‘€ğŸ˜±ğŸ˜¡ğŸ˜­</span>`;
            resultatElement.className = 'result loss';
        }

        sauvegarderValeurs();
    }

    // Remise Ã  zÃ©ro
    function remiseAZero() {
        document.getElementById('prixAchat').value = '';
        document.getElementById('taux').value = '';
        document.getElementById('coefficient').value = '';
        document.getElementById('prixVente').value = '';
        document.getElementById('benefice').value = '';
        document.getElementById('resultat').innerHTML = 'RÃ©sultat : 0.00 â‚¬';
        document.getElementById('resultat').className = 'result';
        localStorage.clear();
    }

    // Ã‰couter les changements sur les champs
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('focus', () => { isEditing = true; });
        input.addEventListener('blur', () => { isEditing = false; calculer(); });
        input.addEventListener('keyup', (e) => {
            // Ne pas recalculer si l'utilisateur utilise les flÃ¨ches ou supprime
            if ([37, 38, 39, 40, 8, 46].includes(e.keyCode)) return;
            calculer();
        });
    });

    // Charger les valeurs au dÃ©marrage
    chargerValeurs();
</script>